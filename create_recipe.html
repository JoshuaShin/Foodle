<!DOCTYPE html>
<html>
<head>
    <link rel = "stylesheet" type = "text/css" href = "css/style.css">

    <script src="https://www.gstatic.com/firebasejs/5.9.3/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyBrGlVFqo2ixWMzeeq6ppt4jaMErC8H5LY",
        authDomain: "foodle-d4b88.firebaseapp.com",
        databaseURL: "https://foodle-d4b88.firebaseio.com",
        projectId: "foodle-d4b88",
        storageBucket: "foodle-d4b88.appspot.com",
        messagingSenderId: "506441498159"
      };
      firebase.initializeApp(config);
    </script>

    <script>
        $(document).ready(function(){
            $(".hide").hide();
          });
    </script>

    <style>
        #createRecipeHolder {
            padding-left: 23.75%; padding-right: 23.75%;
        }
        textarea {
            border-radius: 1px;
            background-color: rgba(45, 45, 45, 0.60);
            padding: 10px;
            outline: none;
            color: whitesmoke;
        }
        p {
            color: whitesmoke;
        }
    </style>
</head>
<body>
    
    <div>
        <div id = "searchTop">
            <a id = "foodleLogo" class = "unselectable" href = "./index.html"><h1>FOODLE</h1></a>
        </div>

        <br/>
        <div id = "createRecipeHolder">
            <p>Title</p>
            <textarea id = "title" rows = "1" cols = "110" placeholder="Your Amazing Recipe!"></textarea>
            <p>Cook Time (Minutes)</p>
            <textarea id = "cooktime" rows = "1" cols = "110" placeholder="15"></textarea>
            <p>Description</p>
            <textarea id = "description" rows = "6" cols = "110" placeholder="Tell us about your dish"></textarea>
            <p>Ingredients</p>
            <textarea id = "ingredients" rows = "1" cols = "110" placeholder="#Carrots #Peas #Potatoes"></textarea>
            <p>Steps</p>
            <textarea id = "steps" rows = "6" cols = "110" placeholder="1. First step is..."></textarea>
            <p>Image upload</p>
            <div id="filesubmit">
            <input id="imagename" type="file" class="file-select" accept="image/*"/>
            <textarea class = "hide" id = "urladdress" rows = "1" cols = "110" placeholder="https://"></textarea>
            </div>
            <br/><br/>
            <button id = "addRecipeButton">+</button>
        </div> 
        
    <script>


        // DONT TOUCH!!!!!!!!!! KANGMIN IS WORKING ON HERE //

        const storageService = firebase.storage();
        const storageRef = storageService.ref();
        var urladdress

        document.querySelector('.file-select').addEventListener('change', handleFileUploadChange);
        // document.querySelector('.file-submit').addEventListener('click', handleFileUploadSubmit);

        let selectedFile;
        function handleFileUploadChange(e) {
            selectedFile = e.target.files[0];
        }

        function handleFileUploadSubmit(e) {
        const uploadTask = storageRef.child(`images/${selectedFile.name}`).put(selectedFile);
        uploadTask.on('state_changed', (snapshot) => {
        }, (error) => {
            console.log(error);
        }, () => {
            getURLaddress();
            console.log('success');
        });
        }

        // function imgname() {
        //     var imgname = document.getElementById("imagename").files[0]["name"]
        //     console.log(imgname)
        // }

        

        function getURLaddress() {
            var imgname = "images/" + document.getElementById("imagename").files[0]["name"];
            console.log(imgname);
            firebase.storage().ref().child(imgname).getDownloadURL().then( function(url) {
            document.getElementById("urladdress").innerHTML = url;
            console.log("storage image URL: " + url);
            console.log(url);
        }).catch(function(error) {
            console.log(error);
        });
        }
        

        // DONT TOUCH!!!!!!!!!! KANGMIN IS WORKING ON HERE //

        let addRecipeButton = document.getElementById("addRecipeButton");

        addRecipeButton.addEventListener("click", function (event) {
            handleFileUploadSubmit();
            setTimeout(writeRecipe, 1500);
        });

        function writeRecipe() {
            let title = document.getElementById("title").value;
            let cooktime = document.getElementById("cooktime").value;
            let image = document.getElementById("urladdress").value;
            let description = document.getElementById("description").value;
            let ingredients = buildSearchPhraseResult(document.getElementById("ingredients").value);
            let steps = document.getElementById("steps").value;

            if (!title || !description || !ingredients || !steps) {
                window.alert("Empty field!");
            } else {
                let dbref = firebase.database().ref("recipes/" + title).set({
                    "name": title,
                    "cooktime": cooktime,
                    "image" : image,
                    "description": description,
                    "ingredients": ingredients,
                    "steps": steps,
                    "rating": 3,
                    "star": "★★★☆☆", 
                    "updated": new Date(),
                });

                dbref.then(function() {
                    window.location.href = "./search_result.html";
                    window.alert("Recipe added!");
                });    
                            
            }

            function buildSearchPhraseResult(searchPhrase) {
                searchPhraseList = [];
                searchItem = "";
                for (let i = 0; i < searchPhrase.length; i++) {
                    // Add word to list
                    if (searchPhrase[i] == "#" || searchPhrase[i] == ",") {
                        if (searchItem != "") {
                            searchPhraseList.push(searchItem);
                            searchItem = "";
                        }
                        continue;
                    }
                    // Build word
                    if (searchPhrase[i] != " ") {
                        searchItem += searchPhrase[i];
                    }
                }
                // Last word case
                if (searchItem.length > 0) {
                    searchPhraseList.push(searchItem);
                }
                return searchPhraseList;
            }
        }
        
    </script>
</body>
</html>
