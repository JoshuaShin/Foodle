<!DOCTYPE html>
<html>
<head>
    <link rel = "stylesheet" type = "text/css" href = "css/style.css">

    <script src="https://www.gstatic.com/firebasejs/5.9.0/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./js/setup_firebase.js"></script>

    <style>
        .recipeResult {
            border-radius: 1px;
            background-color: rgba(45, 45, 45, 0.60);
            padding: 20px;
            padding-left: 20px;
            border-color: rgba(45, 45, 45, 0.60);
        }
        a {
            text-decoration: none;
        }
        .dropbtn{
            text-align: left;
        }
        #resultHolder{
            padding:20px;
            width:60%;
        }

        #bottomStuff{
            /* position: absolute; */
            position: absolute;
            bottom: 0%;
            left: 67%;
            /* bottom: 0;
            padding: 10px; */
        }

        .item{
            height: 50px;
            width: 50px;
            color: white;
        }
        /* #resultHolder {
           padding-left: 23.75%; padding-right: 23.75%;
        } */
    </style>
</head>
<body>
    <script src="js/add_recipe.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/login.js"></script>

    <div>
        <div id = "searchTop2">
            <a id = "foodleLogo" class = "unselectable" href = "./index.html"><h1>FOODLE</h1></a>
            <input id = "searchBar" type = "text" placeholder = "#Carrots #Peas #Potatoes #Lunch #Vegan">
            <button id = "searchButton">Q</button>
            
        </div>
        <div class="ingredientdown" style="float:left; position: absolute; left: 1.2%">
            <button class="ingredientbtn">ingredients</button>
            <div class="ingredient-content" style="left:0;">
                <table class="buttontable">
                    <tr class="tablecontents"><div id = "tr1"></div></tr>
                </table>
            </div>
        </div>
        <div class="dropdown" style="float:right; position: absolute; right: 47%">
            <button class="dropbtn">sort</button>
            <div class="dropdown-content" style="right:0;">
                <a onclick="alphabetical()">alphabetical</a>
                <a onclick="userrating()">user rating</a>
                <a onclick="cooktime()">cook time</a>
                <a onclick="alphabetical()">last updated</a>
            </div>
        </div>

        

        <br/>

        <div class = 'container'>
        <div id = "resultHolder" class = "resultHolder">
            <div class = "displayresult">
            </div>

            <div class = "AddRecipe">
                <a href = "./create_recipe.html">
                    <h2 style = "color: whitesmoke;">Add Recipe</h2>    
                </a>
            </div>
            </br>
        </div>

        <div id = 'seperation' class = 'seperation'></div>
        </div>
    </div>
        </div>
        
    </div>

    <script src="js/search.js"></script>

    <script>    
        // ===== GLOBALS ===== //
        let recipeDatabase = {};
        let searchPharseList = [];
        let meatandfish = ["chicken", "port", "beef", "salmon", "tuna", "turkey", "chickenbreast", "butter", "cheese"];
        let liquid = ["galicsauce", "oil", "coconutmilk", "milk", "cream", "tomatosauce", "teriyakisauce"]
        let currentRecipe = '';
        // ===== GLOBALS ===== //
        // ===== ASYNCHRONOUS TASKS: DATABASE RETRIEVAL & DISPLAY SEARCH RESULT ===== //
        var dbref = firebase.database().ref().child("recipes");
        dbref.on(
            "value",
            function(snap) {
                recipeDatabase = snap.val();
                matchResultToDatabase();
            });
        // ===== ASYNCHRONOUS TASKS: DATABASE RETRIEVAL & DISPLAY SEARCH RESULT ===== //
        // ===== SYNCHRONOUS TASKS ===== //
        searchPharseList = JSON.parse(sessionStorage.getItem("searchPhraseList")); //["chicken", "onion", "pepper", "rice"];
        document.getElementById('searchBar').value = sessionStorage.getItem("searchPhrase");
        Array.prototype.diff = function(arr) {
            return this.filter( function(val) {
                return arr.indexOf(val) < 0;
            });
        };
        // ===== SYNCHRONOUS TASKS ===== //

        // ===== KANGMIN WORKING ON HERE ===== //
        function maketr1() {
            for(let i = 0; i < searchPharseList.length; i++) {
                if(meatandfish.includes(searchPharseList[i])) {
                    var para = document.createElement("th");
                    para.innerHTML = `</br>` + searchPharseList[i] + `</br></br><input type="range" onchange="myFunction()" min="0" max="1000" value="500" class="slider" id="` + searchPharseList[i] + `">
                    </br></br>gram : <span id="demo`+ i +`">500</span>g`;
                    document.getElementById("tr1").appendChild(para);
                }else if (liquid.includes(searchPharseList[i])){
                    var para = document.createElement("th");
                    para.innerHTML = `</br>` + searchPharseList[i] + `</br></br><input type="range" onchange="myFunction()" min="0" max="1000" value="500" class="slider" id="` + searchPharseList[i] + `">
                    </br></br>Liter : <span id="demo`+ i +`">500</span>ml`;
                    document.getElementById("tr1").appendChild(para);
                }else{
                    var para = document.createElement("th");
                    para.innerHTML = `</br>` + searchPharseList[i] + `</br></br><input type="range" onchange="myFunction()" min="0" max="10" value="5" class="slider" id="` + searchPharseList[i] + `">
                    </br></br>EA : <span id="demo`+ i +`">5</span>`;
                    document.getElementById("tr1").appendChild(para); 
                }
            }
        }

        maketr1();

        function madeThisRecipe() {
            let sliders = document.getElementsByClassName("slider");
            let ingredientsUsed = {}
            let historyMade = {}

            firebase.auth().onAuthStateChanged(function(user){
                if(user){
                    console.log(user.uid)

                    var dbref = firebase.database().ref().child("users/" + user.uid + "/ingredients/");
                    dbref.on(
                        "value",
                        function(snap) {
                            let existingIngredientsUsed = snap.val();
                            console.log(existingIngredientsUsed);

                            for (var key in existingIngredientsUsed) {
                                ingredientsUsed[key] = existingIngredientsUsed[key];
                                console.log(ingredientsUsed);
                            }
                            console.log(sliders.length)

                            for(let i = 0; i < sliders.length; i++) {

                                if (sliders[i].id in ingredientsUsed) {
                                    ingredientsUsed[sliders[i].id] += Number(sliders[i].value);
                                }
                                else {
                                    ingredientsUsed[sliders[i].id] = Number(sliders[i].value);
                                }

                                historyMade[new Date().toString()] = currentRecipe;

                                console.log(ingredientsUsed);
 

                                
                            }

                        });

                        setTimeout(function(){
                            recordHistoryAndIngredients(historyMade, ingredientsUsed, user.uid)
                            window.alert(currentRecipe + " added to history!");
                        }, 1000); 

                }




            })
            


            
        }

        function recordHistoryAndIngredients(historyMade, ingredientsUsed, uid) {

                    let dbref = firebase.database().ref("users/" + uid + "/history/").update(
                        historyMade
                    );
                    let dbref2 = firebase.database().ref("users/" + uid + "/ingredients/").set(
                        ingredientsUsed
                    );
                }

        
        
    
        function myFunction() {
            let sliders = document.getElementsByClassName("slider");
            for(let i = 0; i < searchPharseList.length; i++) {
                var x = sliders[i].value;
                document.getElementById("demo" + i).innerHTML = x;
            }
        }

        // ===== KANGMIN WORKING ON HERE ===== //

        
        // ===== FUNCTIONS ===== //
        function matchResultToDatabase() {
            for(let recipe in recipeDatabase) {
                let ingredients = recipeDatabase[recipe]['ingredients'];
                
                let result = searchPharseList.diff(ingredients);
                if (result.length <= 0) {
                    displayRecipeResultElement(recipeDatabase[recipe]);
                }
            }
            assignRecipeOnClick();
        }

        function displayRecipeResultElement(recipeDictionary) {

            document.getElementById("resultHolder").innerHTML = 
            `
            <div  class = "recipeResult" id = "` + recipeDictionary['name'] + `" data-cooktime = "`+ recipeDictionary['cooktime'] +`"data-rating = "`+ recipeDictionary['rating'] +`>
                <a href = "https://www.google.ca/">
                    <div><div class ="image-wrapper"><img src="`+ recipeDictionary['image'] +`" height="100" width="300"></div><h2 style = "color: whitesmoke;"> ` + recipeDictionary['name'] + 
                    `<span class = "timeandrating"><span class = "star">` + recipeDictionary['star'] + ` </span></span></h2></div>
                    <div><p style = "color: whitesmoke;"> Description: ` + recipeDictionary['description'] + ` </p></div>
                    <p style = "color: whitesmoke;">cooktime:  ` + recipeDictionary['cooktime'] + `</p>
                    <div><p style = "color: whitesmoke;"> Ingredients: ` + buildIngredientsList(recipeDictionary) + `</p></div>
                </a>
            </div>
            ` + document.getElementById("resultHolder").innerHTML;
            hide();
        }
        function assignRecipeOnClick() {
            let resultHolderChildren = document.getElementById("resultHolder").children;
            for (let i = 0; i < resultHolderChildren.length; i++) {
                if (resultHolderChildren[i].id) {
                    resultHolderChildren[i].onclick = function() {
                        openup(recipeDatabase[resultHolderChildren[i].id]);
                    };
                }
            }
        }
        function hide(){
            document.getElementById('seperation').style.display = 'none';
        }
        function openup(recipeDictionary){
            currentRecipe = recipeDictionary['name'];
            document.getElementById("seperation").innerHTML = 
            `
            <div class = "okay">
            <div><p style = "color: whitesmoke;"><b>Recipe Name: </b>` + recipeDictionary['name'] + `</p></div>
            <br>   
            <div><p style = "color: whitesmoke;"><b>Description: </b>` + recipeDictionary['description'] + `</p></div>
            <br>
            <div><p style = "color: whitesmoke;"><b>Cooktime: </b>` + recipeDictionary['cooktime'] + `</p></div>
            <br>
            <div class = "star"><b>Rating: </b>` + recipeDictionary['star'] + `</div>
            <br>
            <div><p style = "color: whitesmoke;"><b>Recipe Steps: </b>` + recipeDictionary['steps'] + `</p></div>
            <br>
            <div><img src="`+ recipeDictionary['image'] + `"></p></div>
            <div id = "bottomStuff">
                <img src="images/download.png" class = "item">
                <img src="images/printer.png" class = "item">
                <img src="images/save.png" class = "item" onclick = "madeThisRecipe()">
            </div>
            </div>`; 

            document.getElementById('seperation').style.display = 'block';
        }
        function closedown(){
            document.getElementById('seperation').style.display = 'none';
        }
        function buildIngredientsList(recipeDictionary) {
            return recipeDictionary['ingredients'].join(', ');
        }
        function alphabetical() {
            $('.recipeResult').sort(function(a, b) {
                if (a.textContent < b.textContent) {
                    return -1;
                } else {
                    return 1;
                }
                }).appendTo('.displayresult');
        }
        function cooktime() {
            $('.recipeResult').sort(function(a, b) {
                if ($(a).data('cooktime') < $(b).data('cooktime')) {
                    return -1;
                } else {
                    return 1;
                }
                }).appendTo('.displayresult');
        }
        function userrating() {
            $('.recipeResult').sort(function(a, b) {
                if ($(a).data('rating') > $(b).data('rating')) {
                    return -1;
                } else {
                    return 1;
                }
                }).appendTo('.displayresult');
        }
        // ===== FUNCTIONS ===== //
    </script>
</body>
</html>